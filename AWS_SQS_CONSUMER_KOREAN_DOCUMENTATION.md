# AWS SQS Consumer λ¨λ“ ν•κΈ€ μ£Όμ„ μ‘μ—… μ™„λ£ λ³΄κ³ μ„

## μ‘μ—… κ°μ”

AWS Kitμ SQS Consumer λ¨λ“μ— λ€ν•΄ μ°μ„ μμ„μ— λ”°λ¥Έ ν•κΈ€ μ£Όμ„ μ‘μ—…μ„ μ™„λ£ν•μ€μµλ‹λ‹¤. μ΄λ² μ‘μ—…μΌλ΅ κ°λ°μλ“¤μ΄ SQS Consumerμ λ³µμ΅ν• Thread κ΄€λ¦¬, Virtual Thread ν™μ©, λ©”νΈλ¦­ μμ§‘ λ“±μ„ λ” μ‰½κ² μ΄ν•΄ν•  μ μκ² λμ—μµλ‹λ‹¤.

## μ‘μ—… μ™„λ£λ ν΄λμ¤λ“¤

### π”¥ μµκ³  μ°μ„ μμ„ - ν•µμ‹¬ κµ¬ν„ ν΄λμ¤

#### 1. SqsListenerContainer.java
- **μ—­ν• **: SQS λ©”μ‹μ§€ μ†λΉ„λ¥Ό μ„ν• ν•µμ‹¬ μ»¨ν…μ΄λ„ ν΄λμ¤
- **μ£Όμ” νΉμ§•**:
  - Long Pollingμ„ ν†µν• ν¨μ¨μ μΈ λ©”μ‹μ§€ μμ‹ 
  - Thread Poolμ„ μ‚¬μ©ν• λΉ„λ™κΈ° λ©”μ‹μ§€ μ²λ¦¬
  - Retry λ° Dead Letter Queue(DLQ) μ§€μ›
  - Thread-safeν• μ»¨ν…μ΄λ„ μƒλ…μ£ΌκΈ° κ΄€λ¦¬
  - λ©”μ‹μ§€ μ²λ¦¬ ν†µκ³„ λ° λ¨λ‹ν„°λ§ μ§€μ›

**ν•µμ‹¬ μ£Όμ„ λ‚΄μ©**:
- SQS Consumer ν¨ν„΄κ³Ό Long Polling λ°©μ‹ μ„¤λ…
- Thread λ¨λΈ (Polling Thread vs Message Processing Threads)
- Virtual Thread vs Platform Thread μ°¨μ΄μ 
- λ³΄μ• κ°μ„ μ‚¬ν•­ (Jackson ObjectMapper, Thread μ•μ „μ„±)
- μƒνƒ κ΄€λ¦¬μ™€ λ™μ‹μ„± μ²λ¦¬ λ°©μ‹

### π€ λ†’μ€ μ°μ„ μμ„ - Thread Pool λ° ExecutorService

#### 2. VirtualThreadExecutorServiceProvider.java
- **μ—­ν• **: Java 21+ Virtual Thread ExecutorService μ κ³µμ
- **Java 21 νΉμ„± μ„¤λ…**:
  - Virtual Threadμ μ¥μ κ³Ό νΉμ„± μƒμ„Έ μ„¤λ…
  - I/O μ§‘μ•½μ  μ‘μ—…μ— μµμ ν™”λ κ²½λ‰ μ¤λ λ“
  - Platform Threadμ™€μ μ„±λ¥ λΉ„κµν‘ ν¬ν•¨
  - SQS Consumerμ—μ„μ ν™μ©λ²•

**ν•µμ‹¬ μ£Όμ„ λ‚΄μ©**:
- Virtual Thread κ°λ…κ³Ό λ©”λ¨λ¦¬ ν¨μ¨μ„±
- SQS Long Pollingκ³Ό Virtual Threadμ κ¶ν•©
- Java 21+ μ”κµ¬μ‚¬ν•­κ³Ό ν•μ„ νΈν™μ„± μ²λ¦¬
- λ¦¬ν”λ ‰μ…μ„ ν†µν• μ•μ „ν• Virtual Thread μƒμ„±

#### 3. PlatformThreadExecutorServiceProvider.java
- **μ—­ν• **: μ „ν†µμ μΈ Platform Thread ExecutorService μ κ³µμ
- **Thread κ΄€λ¦¬ νΉμ„±**:
  - OS λ„¤μ΄ν‹°λΈ μ¤λ λ“ μ‚¬μ©κ³Ό λ©”λ¨λ¦¬ λΉ„μ©
  - CPU μ§‘μ•½μ  μ‘μ—…μ— μ ν•©ν• νΉμ„±
  - μ¤λ λ“ ν’€ κ΄€λ¦¬μ™€ Graceful Shutdown
  - Virtual Threadμ™€μ λΉ„κµ λ¶„μ„

### π“ μ¤‘κ°„ μ°μ„ μμ„ - λ©”νΈλ¦­μ¤ λ° λ¨λ‹ν„°λ§

#### 4. MetricsCollector.java (μΈν„°νμ΄μ¤)
- **μ—­ν• **: SQS Consumer λ©”νΈλ¦­ μμ§‘ λ° κ΄€λ¦¬ μΈν„°νμ΄μ¤
- **μμ§‘ν•λ” μ£Όμ” λ©”νΈλ¦­**:
  - λ©”μ‹μ§€ μ²λ¦¬ ν†µκ³„: μ„±κ³µ/μ‹¤ν¨ κ±΄μ, μ²λ¦¬ μ‹κ°„
  - μ»¨ν…μ΄λ„ μƒνƒ: μƒνƒ μ „ν™ νμ, ν„μ¬ μƒνƒ
  - μ„±λ¥ μ§€ν‘: ν‰κ· /μµλ€/μµμ† μ²λ¦¬ μ‹κ°„
  - μ¤λ¥ μ²λ¦¬: DLQ μ „μ†΅, μ¬μ‹λ„ ν†µκ³„

#### 5. InMemoryMetricsCollector.java
- **μ—­ν• **: λ©”λ¨λ¦¬ κΈ°λ° MetricsCollector κµ¬ν„μ²΄
- **Thread μ•μ „μ„± μ „λµ**:
  - ConcurrentHashMapκ³Ό AtomicLongμ„ μ‚¬μ©ν• λ™μ‹μ„± λ³΄μ¥
  - Mutable/Immutable ν¨ν„΄μΌλ΅ λ°μ΄ν„° λ¬΄κ²°μ„± λ³΄μ¥
  - μ‹¤μ‹κ°„ λ©”νΈλ¦­ κ³„μ‚°κ³Ό λ¶λ³€ κ°μ²΄ λ°ν™

### β™οΈ λ‚®μ€ μ°μ„ μμ„ - μ„¤μ • λ° μ ν‹Έλ¦¬ν‹°

#### 6. SqsConsumerProperties.java
- **μ—­ν• **: SQS Consumer μ„¤μ • μ†μ„± μ¤‘μ•™ κ΄€λ¦¬
- **μ„¤μ • μΉ΄ν…κ³ λ¦¬**:
  - λ©”μ‹μ§€ μ²λ¦¬ μ„¤μ •: λ™μ‹μ„±, νƒ€μ„μ•„μ›ƒ, λ°°μΉ μ‚¬μ΄μ¦
  - μ¤λ λ“ ν’€ μ„¤μ •: Platform/Virtual Thread μ„¤μ •
  - μ¬μ‹λ„ λ° μ¤λ¥ μ²λ¦¬: μ¬μ‹λ„ μ •μ±…, DLQ μ„¤μ •
  - λ¨λ‹ν„°λ§: λ©”νΈλ¦­ μμ§‘, ν—¬μ¤ μ²΄ν¬ μ„¤μ •

## μ£Όμ” κΈ°μ  νΉμ„± μ„¤λ…

### π§µ Thread λ¨λΈ λ¶„μ„

#### Virtual Thread vs Platform Thread λΉ„κµν‘
| μ”μ† | Platform Thread | Virtual Thread |
|------|----------------|----------------|
| λ©”λ¨λ¦¬ μ‚¬μ©λ‰ | 1-2MB/μ¤λ λ“ | μ KB/μ¤λ λ“ |
| λ™μ‹ μ‹¤ν–‰ κ°€λ¥ μ | μμ‹­-μλ°±κ° | μλ°±λ§κ° |
| CPU μ§‘μ•½μ  μ‘μ—… | μ°μ | λ³΄ν†µ |
| I/O μ§‘μ•½μ  μ‘μ—… | λ³΄ν†µ | μ°μ |

#### SQS Consumerμ—μ„μ Thread ν™μ©
- **Polling Thread**: SQSμ—μ„ λ©”μ‹μ§€λ¥Ό μμ‹ ν•λ” μ „μ© μ¤λ λ“
- **Message Processing Threads**: μμ‹ λ λ©”μ‹μ§€λ¥Ό μ‹¤μ λ΅ μ²λ¦¬ν•λ” μ›μ»¤ μ¤λ λ“λ“¤
- **Virtual Thread μ¥μ **: I/O λ€κΈ° μ‹ μ¤λ λ“κ°€ parkλμ–΄ CPU μμ› μ μ•½

### π”’ λ³΄μ• κ°•ν™” μ‚¬ν•­

#### Jackson ObjectMapperλ¥Ό ν†µν• μ•μ „ν• JSON μ§λ ¬ν™”
- DLQ λ©”μ‹μ§€ μƒμ„±μ‹ λ¬Έμμ—΄ μ—°κ²° λ€μ‹  Jackson μ‚¬μ©
- JSON μΈμ μ… κ³µκ²© λ°©μ§€
- AUTO_CLOSE_SOURCE κΈ°λ¥ λΉ„ν™μ„±ν™”λ΅ λ³΄μ• μ·¨μ•½μ  μ°¨λ‹¨

#### Thread μ•μ „μ„± λ³΄μ¥
- Atomic μ—°μ‚°μ„ ν†µν• Thread-safe μƒνƒ κ΄€λ¦¬
- ConcurrentHashMap μ‚¬μ©ν• λ©”νΈλ¦­ λ™μ‹μ„± μ²λ¦¬
- UncaughtExceptionHandlerλ¥Ό ν†µν• μ¤λ λ“ μμ™Έ μ²λ¦¬

### π“ λ©”νΈλ¦­ λ° λ¨λ‹ν„°λ§

#### μμ§‘λλ” ν•µμ‹¬ μ§€ν‘λ“¤
- **μ„±λ¥ λ©”νΈλ¦­**: ν‰κ· /μµλ€/μµμ† μ²λ¦¬ μ‹κ°„, μ²λ¦¬λ‰
- **μƒνƒ λ©”νΈλ¦­**: μ»¨ν…μ΄λ„ μƒνƒ μ „ν™, ν™μ„± μƒνƒ
- **μ¤λ¥ λ©”νΈλ¦­**: μ‹¤ν¨μ¨, DLQ μ „μ†΅ μ„±κ³µλ¥ , μ¬μ‹λ„ νμ
- **μ‹μ¤ν… λ©”νΈλ¦­**: μ¤λ λ“ ν’€ μ‚¬μ©λ¥ , λ©”λ¨λ¦¬ μ‚¬μ©λ‰

#### Thread-safe λ©”νΈλ¦­ μμ§‘
- AtomicLongμ„ μ‚¬μ©ν• μ›μμ  μΉ΄μ΄ν„° μ—°μ‚°
- volatile λ³€μλ¥Ό ν†µν• λ‹¨μ κ°’ κ°€μ‹μ„± λ³΄μ¥
- synchronized λΈ”λ΅μ€ λ³µμ΅ν• μ—…λ°μ΄νΈμ—μ„λ§ μ ν•μ  μ‚¬μ©

## κ°λ°μ κ²½ν— ν–¥μƒ

### π“ μƒμ„Έν• μ‚¬μ© μμ‹ μ κ³µ
λ¨λ“  μ£Όμ” ν΄λμ¤μ— μ‹¤μ  μ‚¬μ©λ²•μ„ λ³΄μ—¬μ£Όλ” μ½”λ“ μμ‹λ¥Ό ν¬ν•¨ν•μ€μµλ‹λ‹¤.

```java
@SqsListener(queueName = "my-queue", maxMessagesPerPoll = 10)
public void handleMessage(SqsMessage message) {
    // λ©”μ‹μ§€ μ²λ¦¬ λ΅μ§
}
```

### π”§ μ„¤μ • κ°€μ΄λ“ ν¬ν•¨
application.yml μ„¤μ • μμ‹μ™€ κ° μ†μ„±μ μν–¥λ„λ¥Ό μƒμ„Έν μ„¤λ…ν•μ€μµλ‹λ‹¤.

```yaml
aws:
  sqs:
    consumer:
      executor:
        type: VIRTUAL_THREADS
        prefer-virtual-threads: true
```

### β οΈ μ£Όμμ‚¬ν•­ λ° λ¨λ²” μ‚¬λ΅€
- Java 21+ μ”κµ¬μ‚¬ν•­κ³Ό ν•μ„ νΈν™μ„± μ²λ¦¬ λ°©λ²•
- μ¤λ λ“ ν’€ ν¬κΈ° μ„¤μ • μ‹ κ³ λ ¤μ‚¬ν•­
- λ©”μ‹μ§€ μ²λ¦¬ μ‹κ°„κ³Ό visibility timeout κ΄€κ³„
- DLQ ν™μ©κ³Ό μ¬μ‹λ„ μ •μ±… μ„¤μ •

## Virtual Thread ν™μ© κ°€μ΄λ“

### π― Virtual Thread μ‚¬μ© κ¶μ¥ μ‚¬λ΅€
- **I/O μ§‘μ•½μ **: SQS Long Polling, λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²°, μ™Έλ¶€ API νΈμ¶
- **λ†’μ€ λ™μ‹μ„±**: μμ² κ°μ λ™μ‹ μ—°κ²° μ²λ¦¬
- **λ©”λ¨λ¦¬ ν¨μ¨μ„±**: μ ν•λ λ©”λ¨λ¦¬μ—μ„ λ§μ€ μ‘μ—… μ²λ¦¬

### β΅ Platform Thread μ‚¬μ© κ¶μ¥ μ‚¬λ΅€
- **CPU μ§‘μ•½μ **: λ³µμ΅ν• κ³„μ‚°, μ•”νΈν™” μ‘μ—…
- **ν•μ„ νΈν™μ„±**: Java 21 μ΄μ „ λ²„μ „ μ§€μ› ν•„μ”
- **μ„Έλ°€ν• μ μ–΄**: μ¤λ λ“ μμ™€ λ¦¬μ†μ¤ μ‚¬μ©λ‰ μ •λ°€ μ μ–΄

## λ§λ¬΄λ¦¬

μ΄λ² ν•κΈ€ μ£Όμ„ μ‘μ—…μ„ ν†µν•΄ AWS SQS Consumer λ¨λ“μ λ³µμ΅ν• λ‚΄λ¶€ κµ¬μ΅°μ™€ Java 21μ μµμ‹  κΈ°λ¥μΈ Virtual Thread ν™μ©λ²•μ„ λ…ν™•ν λ¬Έμ„ν™”ν•μ€μµλ‹λ‹¤. κ°λ°μλ“¤μ΄ λ” μ‰½κ² μ΄ν•΄ν•κ³  ν¨κ³Όμ μΌλ΅ ν™μ©ν•  μ μλ„λ΅ μ‹¤μ©μ μΈ κ°€μ΄λ“μ™€ λ¨λ²” μ‚¬λ΅€λ¥Ό ν¬ν•¨ν•μ€μµλ‹λ‹¤.

### μ£Όμ” μ„±κ³Ό
- β… μ΄ 6κ° ν•µμ‹¬ ν΄λμ¤μ— μƒμ„Έν• ν•κΈ€ μ£Όμ„ μ¶”κ°€
- β… Virtual Threadμ™€ Platform Threadμ νΉμ„±κ³Ό ν™μ©λ²• μƒμ„Έ μ„¤λ…
- β… Thread μ•μ „μ„±κ³Ό λ³΄μ• κ°•ν™” λ°©μ• λ¬Έμ„ν™”
- β… λ©”νΈλ¦­ μμ§‘ λ° λ¨λ‹ν„°λ§ λ°©λ²• κ°€μ΄λ“ μ κ³µ
- β… μ‹¤μ©μ μΈ μ„¤μ • μμ‹μ™€ μ£Όμμ‚¬ν•­ ν¬ν•¨

μ΄μ  κ°λ°ν€μ—μ„ AWS SQS Consumerλ¥Ό λ”μ± ν¨κ³Όμ μΌλ΅ ν™μ©ν•μ‹¤ μ μμ„ κ²ƒμ…λ‹λ‹¤.